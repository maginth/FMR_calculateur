<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quelle est votre facilit√© mat√©rielle relative ?</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            overflow-x: hidden;
        }
        form {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .left-column, .right-column {
            width: 48%;
        }
        .left-column {
            margin-right: 20px;
        }
        .right-column {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .panic-gradient {
            background: linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(255,56,0,1) 12%, rgba(255,255,0,1) 28%, rgba(100,255,105,1) 50%, rgba(60,255,141,1) 58%, rgba(68,255,255,1) 77%, rgba(153,227,255,1) 84%, rgba(200,206,255,1) 90%, rgba(255,255,255,1) 100%);
            position: relative;
        }
        .result-emoji {
            text-align:center;
            position: absolute;
            font-size: 2em;
            margin-left: -0.5em;
            margin-top: -0.5em;
            opacity: 0.3;
            text-shadow: 0.045em 0.1em 0.05em rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            user-select: none;
        }
        .result-emoji:hover, .result-emoji.highlight {
            opacity: 1;
        }
        .result-emoji div {
            font-size: 0.6em;
            transform: rotate(15deg);
        }
        #result-band-wrapper {
            width: 100vw;
            height: 10em;
            position: relative;
        }
        #result-band {
            width: 100%;
            height: 100%;
        }
        #result-band-shadow {
            width: 100%;
            height: 100%;
            left: 0.09em;
            top: 0.2em;
            background: rgba(0, 0, 0, 0.3);
            margin: 0;
            opacity: 1;
            position: absolute;
        }
        #result-band-shadow-wrapper {
            position: absolute;
            height: 100%;
            width: 100%;
            filter: blur(0.05em);
        }
        .notes {
            margin-left: 1.5em;
            margin-right: 2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <form id="simulator-form">
            <div class="left-column">
                <h2>Quelle est votre facilit√© mat√©rielle relative ?</h2>
                <label for="patrimoine">Patrimoine dont b√©n√©ficie votre foyer :</label>
                <input type="text" id="patrimoine" name="patrimoine" required><span></span>
                
                <label for="revenus">Revenus net mensuel du foyer :</label>
                <input type="text" id="revenus" name="revenus" required><span></span>

                <label for="parts">Nombre de parts dans le foyer :</label>
                <input type="text" id="parts" name="parts" required><span class='simple'></span>

                <label for="heritage">Futurs donnations ou h√©ritages personnel :</label>
                <input type="text" id="heritage" name="heritage" required><span></span>

                <button type="submit">Calculer</button>
                <div id="result"></div>
            </div>

            <div class="right-column">
                <h2>Donn√©es soci√©tales</h2>
                <label for="select_source">Source des donn√©es :</label>
                <select id="select_source">
                    <option value="france_2023">France 2023 (Source INSEE)</option>
                    <option value="personnalise">Personnalis√©</option>
                </select>
                <label for="patrimoine_med">Patrimoine m√©dian d'un foyer :</label>
                <input type="text" id="patrimoine_med" name="patrimoine_med" placeholder="185000"><span></span>
                
                <label for="revenus_med">Revenus net m√©dian individuel</label>
                <input type="text" id="revenus_med" name="revenus_med" placeholder="2000"><span></span>
                
                <label for="heritage_med">H√©ritages personnel m√©dian sur une vie :</label>
                <input type="text" id="heritage_med" name="heritage_med" placeholder="70000"><span></span>

                <label for="amortissement">ann√©es d'amortissement du patrimoine</label>
                <input type="text" id="amortissement" name="amortissement" placeholder="20"><span></span>

                <label for="seuil_pauvrete">seuil de pauvret√©</label>
                <input type="text" id="seuil_pauvrete" name="seuil_pauvrete" placeholder="1000"><span></span>

                <div id="resulta">
                </div>
            </div>
        </form>
    </div>
    <div id='result-band-wrapper'>
        <div id='result-band' class='panic-gradient'>
            <div id='result-band-shadow-wrapper'>
                <div id='result-band-shadow'></div>
            </div>
            <div id='result-FMR-cursor' class='FMR-cursor'><div><div>37%</div></div></div>
        </div>
    </div>
    <div class='notes'>
        <p><strong>Note 1 :</strong> La facilit√© mat√©rielle relative <strong>ne situe pas votre rang entre le plus pauvre et le plus riche dans une soci√©t√© donn√©e !</strong> L'id√©e est d'avoir une mesure proportionnelle √† la valeurs des biens et services dont b√©n√©ficie une personne au del√† de ses d√©penses contraintes, d√©finit pour tout le monde pour simplifier comme √©gales au seuil de pauvret√©. Dans une soci√©t√© √©galitaire tout le monde serait proche de la situation m√©diane fix√© par construction √† 50%üôÇ (voir Note 2), le seuil de pauvret√© quand √† lui est fix√© √† 0%üò© et ne devrait pas √™tre franchi dans une soci√©t√© parfaitement fonctionnelle, puisque ce seuil est choisi pr√©cis√©ment comme un indicateur pour lutter contre des situations jug√©es inacceptables, car dans la majorit√© des cas elles r√©duisent significativement les oportunit√©s de vie, sont synonyme de privations, et menacent la sant√©, l'√©panouissement social, et de mani√®re g√©n√©rale la dignit√©e des personnes concern√©es. La mesure est donc ¬´ relative ¬ª √† ces seuils fix√©s √† 0%üò© et 50%üôÇ pour permettre de se situer instantan√©ment par rapport √† eux. Il est d'ailleurs possible d'√™tre sous les 0%üò±ü•∂ü•µüò∑ ou au dessus des 100%ü§§üßêü§ë (voir tr√®s tr√®s tr√®s au dessus pour les plus fortun√©s)</p>
        <p><strong>Note 2 :</strong> La situation m√©diane est d√©finie comme la situation d'une personne dans un couple avec deux enfants (renouvellement de la population) poss√©dant le patrimoine m√©dian des foyers dans la soci√©t√© consid√©r√©e (ici par d√©faut la France), qui aurait des revenus m√©dians, et dont il lui resterait encore √† recevoir en h√©ritage la moiti√© de l'h√©ritage individuel m√©dian re√ßu sur une vie (la premi√®re moiti√© √©tant suppos√©e d√©j√† re√ßu et inclus dans son patrimoine). Le seuil de pauvret√© lui est fix√© par les √©conomistes, en France il est d√©fini en g√©n√©rale comme 50% du revenu m√©dian (la situation Fran√ßaise fait qu'√† ce niveau de revenu les personnes ont en moyenne un tr√®s faible patrimoine, qui peut donc √™tre ignor√©, si √ßa n'√©tait pas le cas il faudrait l'inclure de mani√®re amortie dans un seuil de pauvret√© √©tandu comme on le fait avec la situation m√©diane)</p>
    </div>

    <script>
        const formula_replacers = [[',','.'],[/[‚Ç¨_ ]/g,''],[/[√óx]/g,'*'],[/[√∑:]/g, '/'],[/([+-][\d.]+)%/g, '*(1$1/100)'],['%', '/100']]

        let currencies_loaded = false
        function load_currency_converter(callback, s='') {

            const currencies = "ALL|Lek,AFN|ÿã,ARS,AWG|∆í,AUD,AZN|–º–∞–Ω,BSD,BBD,BYR|p.,BZD|BZ$,BMD,BOB|$b,BAM|KM,BWP|P,BGN|–ª–≤,BRL|R$,BND,KHR|·üõ,CAD,KYD,CLP,CNY,COP,CRC|‚Ç°,HRK|kn,CUP|‚Ç±,CZK|Kƒç,DKK,DOP|RD$,XCD,EGP,SVC,EEK,EUR|‚Ç¨,FKP,FJD,GHC|¬¢,GIP,GTQ|Q,GGP,GYD,HNL|L,HKD,HUF|Ft,ISK,INR|ul,IDR|Rp,IRR|Ô∑º,IMP,ILS|‚Ç™,JMD|J$,JPY|¬•,JEP,KZT|–ª–≤,KGS|–ª–≤,LAK|‚Ç≠,LVL|Ls,LBP,LRD,LTL|Lt,MKD|–¥–µ–Ω,MYR|RM,MUR|‚Ç®,MXN,MNT|‚ÇÆ,MZN|MT,NAD,NPR|‚Ç®,ANG|∆í,NZD,NIO|C$,NGN|‚Ç¶,KPW,NOK,OMR,PKR|‚Ç®,PAB|B/.,PYG|Gs,PEN|S/.,PHP|‚Ç±,PLN|z≈Ç,QAR,RON|lei,RUB|—Ä—É–±,SHP,SAR,RSD|–î–∏–Ω.,SCR|‚Ç®,SGD,SBD,SOS|S,ZAR|R,KRW|‚Ç©,LKR|‚Ç®,SEK|kr,CHF|CHF,SRD,SYP,TWD|NT$,THB|‡∏ø,TTD|TT$,TRY|ul,TRL|‚Ç§,TVD,UAH|‚Ç¥,GBP|¬£,UYU|$U,UZS|–ª–≤,VEF|Bs,VND|‚Ç´,YER,ZWD|Z$,USD|$"

            if (s || new RegExp(currencies.replaceAll(',', '|').test(s))) {
                fetch('https://www.floatrates.com/daily/eur.json')
                .then(x => x.json())
                .then(currency_rate => {
                    for (const s of currencies.replaceAll(/([$.])/g, '\\$1').split(',')){
                        formula_replacers.push([
                        new RegExp('(?<!\\w)(?:'+s+')([\\d.]+)|([\\d.]+)(?:'+s+')(?!\\w)', 'ig'),
                        '$1$2*'+currency_rate[s.substr(0,3).toLowerCase()]?.rate
                    ])}
                    currencies_loaded = true
                    callback()
                })
            }
        }
            
        const doc = document
        for (const i of doc.querySelectorAll('input[type=text]'))
            i.title="Nombre ou formule. Exemple : 2 500 ‚Ç¨ / 3 + ($ 11 000 x 2 - 20%)"

        const byid = doc.getElementById.bind(doc)
        const res_el = byid('resulta')

        const num = new Intl.NumberFormat()
        const eur = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' })

        function compute_FMR() {

            function read(s) {
                const el = byid(s)
                const el_eq = el.nextElementSibling
                el.style.background = ''
                el_eq.textContent = ''
                const formula = formula_replacers.reduce((s,[a,b]) => s.replaceAll(a,b), el.value || el.placeholder)
                try {
                    const res = eval(formula)
                    if (res != formula) {
                        el_eq.title = formula
                        el_eq.textContent = '= ' + (el_eq.classList.contains('simple') ? num : eur).format(res)
                    }
                    return res
                } catch(e) {
                    if (!currencies_loaded) {
                        load_currency_converter(compute_FMR, formula)
                        throw 'loading'
                    }
                    el.style.background = 'red'
                    el_eq.title = formula
                    el_eq.textContent = '‚ö†'
                    throw e
                }
            }

            try {
                const patrimoine = read('patrimoine')
                const heritage = read('heritage')
                const parts = read('parts')
                const revenus = read('revenus')

                const patrimoine_med = read('patrimoine_med')
                const heritage_med = read('heritage_med')
                const revenus_med = read('revenus_med')
                const seuil_pauvrete = read('seuil_pauvrete')
                const amortissement = read('amortissement') * 12


                const facilite_materielle = (patrimoine / parts + heritage) / amortissement + revenus / parts - seuil_pauvrete
                const facilite_materielle_med = (patrimoine_med / 3 + heritage_med /2) / amortissement + revenus_med - seuil_pauvrete

                const FMR = Math.round(50 * facilite_materielle / facilite_materielle_med)
                res_el.innerHTML = FMR + '%'
                highlighted_emoji.classList.remove('highlight')
                const l = emoji_list.length-1
                highlighted_emoji = emoji_elements[Math.round(Math.max(0, Math.min(l, (0.2 + FMR / 100 * 0.6) * l)))]
                highlighted_emoji.classList.add('highlight')
            } catch(e) {
                if (e != 'loading')
                    res_el.innerHTML = "erreur"
            }
        }

        byid('simulator-form').addEventListener('submit', e => {e.preventDefault(); compute_FMR()})

        const emoji_list = [..."üò±ü•∂ü•µüò∑üò©üòëüòîüòåüôÇüòéüòÄüòÉüòÑü§§ü§óüßêü§ë"]
        let highlighted_emoji = doc.body
        const emoji_elements = []

        function draw_wave_panic_band(el) {
            let path_start = 'polygon(', path_end = ''
            const phi = 1+Math.sqrt(5)
            let w,x,y,yy,i,ip=-1
            const n = emoji_list.length
            const square_sin = (w, square) => square*(Math.abs(w % 2 - 1))+(1-square)*0.5*(1+Math.cos(w*Math.PI))
            for (let x=0; x<100; x+=0.05) {
                w = 0.0001*(100-x)**3
                // y = 0.1*(100-x)*(Math.abs(w % 2 - 1)+0.5*Math.abs(w % phi - phi*0.5))+0.01*x*(Math.sin(w*Math.PI)+1)+0.15*(100-x)
                // yy = 0.02*(100-x)*Math.abs(w % 20 - 10)
                const square = (1-x*0.01)
                y = 0.1*(100-x)*(square_sin(w, square)+0.5*phi/2*square_sin(w/phi*2, square))+0.15*(100-x)
                yy = 0.2*(100-x)*square_sin(w/10, square)
                path_start += x+'% ' + (y+yy)+'%, '
                path_end   = ', '+ x+'% ' + (80-y+yy)+'%' + path_end

                i = Math.round(n * x * 0.01 - 0.95)
                if (i != ip) {
                    const emoji = doc.createElement('div')
                    emoji.classList.add('result-emoji')
                    emoji_elements.push(emoji)
                    emoji.innerHTML = emoji_list[i]+'<div>'+(Math.round((x-20) / 6) *10)+'%<div>'
                    emoji.style.left = x + '%'
                    emoji.style.top = (30+yy) + '%'
                    el.appendChild(emoji)
                }
                ip = i
            }
            path_start += '100% ' + (y+yy) + '%, 100% '
            const path = path_start + (80-y+yy)+'%' + path_end
            el.style.clipPath = path + ')'
            byid('result-band-shadow').style.clipPath = path + ', 0% 100%, 100% 100%, 100% 0%, 0% 0%)'
        }
        draw_wave_panic_band(byid('result-band'))
    </script>
</body>
</html>