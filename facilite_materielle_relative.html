<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quelle est votre facilitÃ© matÃ©rielle relative ?</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            overflow-x: hidden;
        }
        form {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .left-column, .right-column {
            width: 48%;
        }
        .left-column {
            margin-right: 20px;
        }
        .right-column {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .panic-gradient {
            background: linear-gradient(90deg, rgba(0,0,0,1) 0%, rgba(255,56,0,1) 12%, rgba(255,255,0,1) 28%, rgba(100,255,105,1) 50%, rgba(60,255,141,1) 58%, rgba(68,255,255,1) 77%, rgba(153,227,255,1) 84%, rgba(200,206,255,1) 90%, rgba(255,255,255,1) 100%);
            position: relative;
        }
        .panic-gradient div {
            text-align:center;
            position: absolute;
            font-size: 2em;
            margin-left: -0.5em;
            margin-top: -0.25em;
            opacity: 0.3;
            text-shadow: 0.03em 0.1em 0.01em rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            user-select: none;
        }
        .panic-gradient div:hover {
            opacity: 1;
        }
        #result-band {
            width: 100vw;
            height: 10em;
        }
        #result-band-shadow {
            width: 100%;
            height: 100%;
            top: 0.15em;
            left: 0.035em;
            background: rgba(0, 0, 0, 0.3);
            margin: 0;
            opacity: 1;
        }
        .notes {
            margin-left: 1.5em;
            margin-right: 2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <form id="simulator-form">
            <div class="left-column">
                <h2>Quelle est votre facilitÃ© matÃ©rielle relative ?</h2>
                <label for="patrimoine">Patrimoine dont bÃ©nÃ©ficie votre foyer :</label>
                <input type="text" id="patrimoine" name="patrimoine" required><span></span>
                
                <label for="revenus">Revenus net mensuel du foyer :</label>
                <input type="text" id="revenus" name="revenus" required><span></span>

                <label for="parts">Nombre de parts dans le foyer :</label>
                <input type="text" id="parts" name="parts" required><span class='simple'></span>

                <label for="heritage">Futurs donnations ou hÃ©ritages personnel :</label>
                <input type="text" id="heritage" name="heritage" required><span></span>

                <button type="submit">Calculer</button>
                <div id="result"></div>
            </div>

            <div class="right-column">
                <h2>DonnÃ©es sociÃ©tales</h2>
                <label for="select_source">Source des donnÃ©es :</label>
                <select id="select_source">
                    <option value="france_2023">France 2023 (Source INSEE)</option>
                    <option value="personnalise">PersonnalisÃ©</option>
                </select>
                <label for="patrimoine_med">Patrimoine mÃ©dian d'un foyer :</label>
                <input type="text" id="patrimoine_med" name="patrimoine_med" placeholder="185000"><span></span>
                
                <label for="revenus_med">Revenus net mÃ©dian individuel</label>
                <input type="text" id="revenus_med" name="revenus_med" placeholder="2000"><span></span>
                
                <label for="heritage_med">HÃ©ritages personnel mÃ©dian sur une vie :</label>
                <input type="text" id="heritage_med" name="heritage_med" placeholder="70000"><span></span>

                <label for="amortissement">annÃ©es d'amortissement du patrimoine</label>
                <input type="text" id="amortissement" name="amortissement" placeholder="20"><span></span>

                <label for="seuil_pauvrete">seuil de pauvretÃ©</label>
                <input type="text" id="seuil_pauvrete" name="seuil_pauvrete" placeholder="1000"><span></span>

                <div id="resulta">
                </div>
            </div>
        </form>
    </div>
    <div id='result-band' class='panic-gradient'>
        <div id='result-band-shadow' filter="url(#blurMe)"></div>
    </div>
    <div class='notes'>
        <p><strong>Note 1 :</strong> La facilitÃ© matÃ©rielle relative <strong>ne situe pas votre rang entre le plus pauvre et le plus riche dans une sociÃ©tÃ© donnÃ©e !</strong> L'idÃ©e est d'avoir une mesure proportionnelle Ã  la valeurs des biens et services dont bÃ©nÃ©ficie une personne au delÃ  de ses dÃ©penses contraintes, dÃ©finit pour tout le monde pour simplifier comme Ã©gale au seuil de pauvretÃ©. Dans une sociÃ©tÃ© Ã©galitaire tout le monde serait proche de la situation mÃ©diane fixÃ© par construction Ã  50%ğŸ™‚ (voir Note 2), le seuil de pauvretÃ© quand Ã  lui est fixÃ© Ã  0%ğŸ˜© et ne devrait pas Ãªtre franchi dans une sociÃ©tÃ© parfaitement fonctionnelle, puisque ce seuil est choisi prÃ©cisÃ©ment comme un indicateur pour lutter contre des situations jugÃ©es inacceptables, car dans la majoritÃ© des cas elles rÃ©duisent significativement les oportunitÃ©s de vie, sont synonyme de privations, et menacent la santÃ©, l'Ã©panouissement social, et de maniÃ¨re gÃ©nÃ©rale la dignitÃ©e des personnes concernÃ©es. La mesure est donc Â« relative Â» Ã  ces seuils fixÃ©s Ã  0%ğŸ˜© et 50%ğŸ™‚ pour permettre de se situer instantanÃ©ment par rapport Ã  eux. Il est d'ailleurs possible d'Ãªtre sous les 0%ğŸ˜±ğŸ¥¶ğŸ¥µğŸ˜· ou au dessus des 100%ğŸ¤¤ğŸ§ğŸ¤‘ (voir trÃ¨s trÃ¨s trÃ¨s au dessus pour les plus fortunÃ©s)</p>
        <p><strong>Note 2 :</strong> La situation mÃ©diane est dÃ©finie comme la situation d'une personne dans un couple avec deux enfants (renouvellement de la population) possÃ©dant le patrimoine mÃ©dian des foyers dans la sociÃ©tÃ© considÃ©rÃ©e (ici par dÃ©faut la France), qui aurait des revenus mÃ©dians, et dont il lui resterait encore Ã  recevoir en hÃ©ritage la moitiÃ© de l'hÃ©ritage individuel mÃ©dian reÃ§u sur une vie (la premiÃ¨re moitiÃ© Ã©tant supposÃ©e dÃ©jÃ  reÃ§u et inclus dans son patrimoine). Le seuil de pauvretÃ© lui est fixÃ© par les Ã©conomistes, en France il est dÃ©fini en gÃ©nÃ©rale comme 50% du revenu mÃ©dian (la situation FranÃ§aise fait qu'Ã  ce niveau de revenu les personnes ont en moyenne un trÃ¨s faible patrimoine, qui peut donc Ãªtre ignorÃ©, si Ã§a n'Ã©tait pas le cas il faudrait l'inclure de maniÃ¨re amortie dans un seuil de pauvretÃ© Ã©tandu comme on le fait avec la situation mÃ©diane)</p>
    </div>

    <script>
        const formula_replacers = [[',','.'],[/[â‚¬_ ]/g,''],[/[Ã—x]/g,'*'],[/[Ã·:]/g, '/'],[/([+-][\d.]+)%/g, '*(1$1/100)'],['%', '/100']]

        let currencies_loaded = false
        function load_currency_converter(callback, s='') {

            const currencies = "ALL|Lek,AFN|Ø‹,ARS,AWG|Æ’,AUD,AZN|Ğ¼Ğ°Ğ½,BSD,BBD,BYR|p.,BZD|BZ$,BMD,BOB|$b,BAM|KM,BWP|P,BGN|Ğ»Ğ²,BRL|R$,BND,KHR|áŸ›,CAD,KYD,CLP,CNY,COP,CRC|â‚¡,HRK|kn,CUP|â‚±,CZK|KÄ,DKK,DOP|RD$,XCD,EGP,SVC,EEK,EUR|â‚¬,FKP,FJD,GHC|Â¢,GIP,GTQ|Q,GGP,GYD,HNL|L,HKD,HUF|Ft,ISK,INR|ul,IDR|Rp,IRR|ï·¼,IMP,ILS|â‚ª,JMD|J$,JPY|Â¥,JEP,KZT|Ğ»Ğ²,KGS|Ğ»Ğ²,LAK|â‚­,LVL|Ls,LBP,LRD,LTL|Lt,MKD|Ğ´ĞµĞ½,MYR|RM,MUR|â‚¨,MXN,MNT|â‚®,MZN|MT,NAD,NPR|â‚¨,ANG|Æ’,NZD,NIO|C$,NGN|â‚¦,KPW,NOK,OMR,PKR|â‚¨,PAB|B/.,PYG|Gs,PEN|S/.,PHP|â‚±,PLN|zÅ‚,QAR,RON|lei,RUB|Ñ€ÑƒĞ±,SHP,SAR,RSD|Ğ”Ğ¸Ğ½.,SCR|â‚¨,SGD,SBD,SOS|S,ZAR|R,KRW|â‚©,LKR|â‚¨,SEK|kr,CHF|CHF,SRD,SYP,TWD|NT$,THB|à¸¿,TTD|TT$,TRY|ul,TRL|â‚¤,TVD,UAH|â‚´,GBP|Â£,UYU|$U,UZS|Ğ»Ğ²,VEF|Bs,VND|â‚«,YER,ZWD|Z$,USD|$"

            if (s || new RegExp(currencies.replaceAll(',', '|').test(s))) {
                fetch('https://www.floatrates.com/daily/eur.json')
                .then(x => x.json())
                .then(currency_rate => {
                    for (const s of currencies.replaceAll(/([$.])/g, '\\$1').split(',')){
                        formula_replacers.push([
                        new RegExp('(?<!\\w)(?:'+s+')([\\d.]+)|([\\d.]+)(?:'+s+')(?!\\w)', 'ig'),
                        '$1$2*'+currency_rate[s.substr(0,3).toLowerCase()]?.rate
                    ])}
                    currencies_loaded = true
                    callback()
                })
            }
        }
            
        const doc = document
        for (const i of doc.querySelectorAll('input[type=text]'))
            i.title="Nombre ou formule. Exemple : 2 500 â‚¬ / 3 + ($ 11 000 x 2 - 20%)"

        const byid = doc.getElementById.bind(doc)
        const res_el = byid('resulta')

        const num = new Intl.NumberFormat()
        const eur = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' })

        function compute_FMR() {

            function read(s) {
                const el = byid(s)
                const el_eq = el.nextElementSibling
                el.style.background = ''
                el_eq.textContent = ''
                const formula = formula_replacers.reduce((s,[a,b]) => s.replaceAll(a,b), el.value || el.placeholder)
                try {
                    const res = eval(formula)
                    if (res != formula) {
                        el_eq.title = formula
                        el_eq.textContent = '= ' + (el_eq.classList.contains('simple') ? num : eur).format(res)
                    }
                    return res
                } catch(e) {
                    if (!currencies_loaded) {
                        load_currency_converter(compute_FMR, formula)
                        throw 'loading'
                    }
                    el.style.background = 'red'
                    el_eq.title = formula
                    el_eq.textContent = 'âš '
                    throw e
                }
            }

            try {
                const patrimoine = read('patrimoine')
                const heritage = read('heritage')
                const parts = read('parts')
                const revenus = read('revenus')

                const patrimoine_med = read('patrimoine_med')
                const heritage_med = read('heritage_med')
                const revenus_med = read('revenus_med')
                const seuil_pauvrete = read('seuil_pauvrete')
                const amortissement = read('amortissement') * 12


                const facilite_materielle = (patrimoine / parts + heritage) / amortissement + revenus / parts - seuil_pauvrete
                const facilite_materielle_med = (patrimoine_med / 3 + heritage_med /2) / amortissement + revenus_med - seuil_pauvrete

                res_el.innerHTML = Math.round(50 * facilite_materielle / facilite_materielle_med) + '%'
            } catch(e) {
                if (e != 'loading')
                    res_el.innerHTML = "erreur"
            }
        }

        byid('simulator-form').addEventListener('submit', e => {e.preventDefault(); compute_FMR()})

        const emoji_list = [..."ğŸ˜±ğŸ¥¶ğŸ¥µğŸ˜·ğŸ˜©ğŸ˜”ğŸ˜ŒğŸ™‚ğŸ˜ğŸ˜€ğŸ˜ƒğŸ¤¤ğŸ§ğŸ¤‘"]

        function draw_wave_panic_band(el) {
            let path_start = 'polygon(', path_end = ')'
            const phi = 1+Math.sqrt(5)
            let w,x,y,yy,i,ip=-1
            const n = emoji_list.length
            for (let x=0; x<95; x+=0.1) {
                w = 0.0001*(100-x)**3
                y = 0.1*(100-x)*(Math.abs(w % 2 - 1)+0.5*Math.abs(w % phi - phi*0.5))+0.01*x*(Math.sin(w*Math.PI)+1)+0.15*(100-x) | 0
                yy = 0.02*(100-x)*Math.abs(w % 20 - 10)
                path_start += x+'% ' + (y+yy)+'%, '
                path_end   = ', '+ x+'% ' + (80-y+yy)+'%' + path_end

                i = n * x * 0.01 | 0
                if (i != ip) {
                    const emoji = doc.createElement('div')
                    emoji.textContent = emoji_list[i]
                    emoji.style.left = x + '%'
                    emoji.style.top = (30+yy) + '%'
                    el.appendChild(emoji)
                }
                ip = i
            }
            path_start += '100% ' + (y+yy) + '%, 100% '
            el.style.clipPath = path_start + (80-y+yy)+'%' + path_end
            byid('result-band-shadow').style.clipPath = path_start + '0%, 0% 0%'
        }
        draw_wave_panic_band(byid('result-band'))
    </script>
</body>
</html>